<!--
{
    "title": "オンボロノートPCとRaspberry Piで作るマイクラサーバ",
    "date": "2019-03-04",
    "description": "オンボロPentiumノートPCとRaspberry Piを連携させて、マイクラサーバを作った話です。"
}
-->

# やりたかったこと
* マイクラサーバを建てたい！
* 利用者は友達のみなので数人
* 利用頻度も少ないので24時間駆動は色々な意味でやめたい

# Raspberry Piでサーバを動かそう！（失敗）
* 公式サーバは動かない（当然）
* Spigotサーバも動かない（当然）

Raspberry Pi 2 Model Bでは流石に性能不足でした。ラグが起きるどころか、サーバがクラッシュします。未確認ですがARMプロセッサ（向けのJava）と相性が悪いんじゃないかという指摘もあるようです。

# 解約したスマホでサーバを動かそう！（失敗）
我が家で眠っているDocomo LG G2（Snapdragon 800, RAM 2GB, CyanogenModでAndroid6.0にアップグレード済み）くんにLinux DeployというRoot権限を利用してLinuxを動かすアプリ（apt-getが普通に動く！神！）を入れてSpigotサーバを導入しました。

結果としては、Raspberry Piサーバよりは圧倒的にスムーズに動き、建築中心など負荷の低い作業ならば普通に遊べる程度でした。ですが、Androidを消し去ったわけではないので、Androidの省電力機能で定期的にWi-Fi接続が切断され、その度にサーバがオフラインになるという問題が生じました。試行錯誤しましたが、完全には解消できませんでした。また、元々爆熱になるスマホなので、かなり本体が熱を持った状態が続いていました。

# 仕方ない。ノートPCを鯖にしよう。
最終手段として、2011年Sandy Bridge版Pentium B940搭載のオンボロノートPCをサーバにすることにしました。ですが、サーバの利用者は数人で利用時間もそれほど多いわけではないので、24時間稼働は本体の寿命的にも消費電力的にもしたくありません。
有り難いことに、BIOS画面を見てみるとWake on LANに対応していたので、必要なときだけRaspberry Piからマジックパケットを送信して起動するようなシステムを組むことにしました。

# どんなシステム？
![動作概要図](./images/01/rpimagickpacket.jpg)

1. 利用者が指定のTwitterアカウントにリプライを送る
2. Raspberry Piが定期的にリプライを監視している
3. 新しいリプライを見つけたら、LAN内にマジックパケットを送信
4. ノートPCが自動起動してマイクラサーバが起動する
5. 起動した旨とIPアドレスをツイートする
6. 3時間経過でノートPCは自動シャットダウンする

Raspberry Pi上でのツイート監視、ノートPC上での起動ツイートはRuby＋Twitter Gemで実現しています。自動シャットダウンはWindows標準のshutdownコマンドをバッチファイルで電源投入時に毎回実行しているだけです。なんてシンプル。

このシステムを導入することで鯖管（自分）が行う管理作業がほぼ不要になりました。また、オンボロノートPCといってもスマホ鯖やラズパイ鯖よりは圧倒的な性能があるので、ラグもかなり少なくなりました。

不意にノートPCの排気口を塞いだりすると悲惨な事故に繋がりかねないので、物理的にインシデントを起こさないような対策は必要だと思います。